!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer"],b):"object"==typeof exports?module.exports=b(require("jquery"),require("iscroll-zoom"),require("hammer")):b(a.jQuery,a.IScroll,a.Hammer)}(this,function(a,b,c){"use strict";function d(d,g){function O(){z=!0,D.append(this),_.call(this,w,function(){x=this.naturalWidth,y=this.naturalHeight}),_(C,function(){Q()}),q.call(this,this.src)}function P(){var a={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};F=new b(B[0],a)}function Q(){L=0,M=0,N=0,D.css({width:x,height:y}),fb(D,L,M,N),cb(x,y),F.zoom(F.options.zoomStart),R(x,y);var a=.5*(h-x*F.options.zoomStart),b=.5*(i-y*F.options.zoomStart);F.scrollTo(a,b)}function R(a,b){C.css({width:a,height:b}),B.append(C),F.refresh()}function S(){var b,d,e,a=!!navigator.userAgent.match(/mobile/i);a?(b=new c(C[0]),b.add(new c.Rotate),b.on("rotatemove",function(a){K||(d=a.rotation,d>180?d-=360:-180>d&&(d+=360),e=d>0?1:0>d?-1:0)}),b.on("rotateend",function(a){K||Math.abs(d)>30&&(1==e?T(a.center):-1==e&&U(a.center))})):C.on("dblclick",function(a){T({x:a.clientX,y:a.clientY})})}function T(a){V(90,a)}function U(a){V(-90,a)}function V(a,b){var c,n,o,d,e,f,g,j,k,l,m;K||(K=!0,c=b?$(C,b.x,b.y):Z(C,B,.5*h,.5*i),d=ab(N,c),e=d.x,f=d.y,g=0,j=0,k=0,l=0,m=N+a,90==m||-270==m?(g=e+f,j=f-e,m>N?(k=y-e-f,l=e-f):N>m&&(k=y-f-(x-e),l=e+f-y),n=y,o=x):180==m||-180==m?(g=2*e,j=2*f,m>N?(k=x-e-(y-f),l=y-(e+f)):N>m&&(k=x-(e+f),l=y-f-(x-e)),n=x,o=y):270==m||-90==m?(g=e-f,j=e+f,m>N?(k=e+f-x,l=x-e-(y-f)):N>m&&(k=f-e,l=x-e-f),n=y,o=x):(0==m||360==m||-360==m)&&(g=0,j=0,m>N?(k=e-f,l=e+f-x):N>m&&(k=e+f-y,l=f-e),n=x,o=y),0==N?(L=0,M=0):90==N||-270==N?(L-=e+f,M-=f-e):180==N||-180==N?(L-=2*e,M-=2*f):(270==N||-90==N)&&(L-=e-f,M-=e+f),L=L.toFixed(2)-0,M=M.toFixed(2)-0,fb(D,L,M,N,e,f),gb(D,L,M,m,200,function(){K=!1,N=m%360,L+=g+k,M+=j+l,L=L.toFixed(2)-0,M=M.toFixed(2)-0,fb(D,L,M,N),F.scrollTo(F.x-k*F.scale,F.y-l*F.scale),cb(n,o),F.scale<F.options.zoomMin&&F.zoom(F.options.zoomMin),R(n,o)}))}function W(){E=document.createElement("canvas"),E.width=h,E.height=i}function X(){var a,b,c,d;z&&(a=Z(C,B),b=F.scale,c=E.getContext("2d"),c.clearRect(0,0,E.width,E.height),c.save(),o?c.scale(b,b):(E.width=h/b,E.height=i/b),c.translate(L-a.x/b,M-a.y/b),c.rotate(N*Math.PI/180),c.drawImage(w[0],0,0),c.restore(),d=E.toDataURL(n,1),s.call(w[0],d))}function Y(){_(A,function(){G=A.width(),H=A.height()})}function Z(a,b,c,d){c=c||0,d=d||0;var e,f;return _(a,function(){e=a.offset()}),_(b,function(){f=b.offset()}),{x:f.left-e.left+c,y:f.top-e.top+d}}function $(a,b,c){b=b||0,c=c||0;var d;return _(a,function(){d=a.offset()}),{x:b+J.scrollLeft()-d.left,y:c+J.scrollTop()-d.top}}function _(b,c){var d=a();a.each(b,function(b,c){var g,e=a(c),f=e.parents().andSelf().filter(":hidden");for(b=0;b<f.length&&e.is(":hidden");b++)g=f.eq(b),"none"==g.css("display")&&(d=d.add(g.show()))}),"function"==typeof c&&c.call(this),d.hide()}function ab(a,b){var c=F.scale,d={};return 0==a?(d.x=b.x/c,d.y=b.y/c):90==a||-270==a?(d.x=b.y/c,d.y=y-b.x/c):180==a||-180==a?(d.x=x-b.x/c,d.y=y-b.y/c):(270==a||-90==a)&&(d.x=x-b.y/c,d.y=b.x/c),d}function bb(a,b,c,d){var e=a/c,f=b/d;return e>f?e:f}function cb(a,b){F.options.zoomMin=bb(h,i,a,b),F.options.zoomMax=Math.max(1,F.options.zoomMin),F.options.zoomStart=Math.min(F.options.zoomMax,bb(G,H,a,b))}function db(a,b,c,d){var e,f,g,h,i,j,k,l;return b=b||.8,c=c||0,e=d||"image/jpeg",f=a.naturalWidth,g=a.naturalHeight,h=Math.max(f,g),h>1024&&(i=Math.min(f,g),i=1024*(i/h),h=1024,f>g?(f=h,g=i):(f=i,g=h)),j=document.createElement("canvas"),k=j.getContext("2d"),c?(j.width=g,j.height=f,k.translate(g,0),k.rotate(c*Math.PI/180)):(j.width=f,j.height=g),k.drawImage(a,0,0,f,g),l=j.toDataURL(e,b||.8)}function eb(b){w&&w.length&&(w.remove(),delete w[0]),w=a("<img>").css({"user-select":"none","pointer-events":"none"}),w.load(O),w.attr("src",b)}function fb(a,b,c,d,f,g){f=f||0,g=g||0;var h={};h[e+"transform"]="translateZ(0) translate("+b+"px,"+c+"px) rotate("+d+"deg)",h[e+"transform-origin"]=f+"px "+g+"px",a.css(h)}function gb(a,b,c,d,g,h){a.css(e+"transform"),a.css(e+"transition",e+"transform "+g+"ms"),a.one(f,function(){a.css(e+"transition",""),h.call(this)}),a.css(e+"transform","translateZ(0) translate("+b+"px,"+c+"px) rotate("+d+"deg)")}function hb(){A=a(d).css({"user-select":"none",overflow:"hidden"}),"static"==A.css("position")&&A.css("position","relative"),B=a("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:h,height:i,"margin-left":-h/2,"margin-top":-i/2}).appendTo(A),C=a("<div class='photo-clip-moveLayer'>").appendTo(B),D=a("<div class='photo-clip-rotateLayer'>").appendTo(C);var b=a("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(A);a("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:i,"margin-right":h/2,"margin-top":-i/2,"margin-bottom":-i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":h/2,"margin-top":-i/2,"margin-bottom":-i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:h,height:i,"margin-left":-h/2-1,"margin-top":-i/2-1}).appendTo(b)}var v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,h=g.width,i=g.height,j=g.defaultImg,k=g.file,l=g.ok,m=g.fileMinSize,n=g.outputType||"image/jpeg",o=g.strictSize,p=g.loadStart,q=g.loadComplete,r=g.loadError,s=g.clipFinish,t=g.loadProgress,u=g.formatError;"jpg"===n?n="image/jpeg":"png"===n&&(n="image/png"),v=a(k),v.length&&(j&&eb(j),v.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return a.isFunction(u)?u():alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var b=new FileReader;b.onprogress=function(b){a.isFunction(t)&&t((100*(b.loaded/b.total)).toFixed())},b.onload=function(b){var d,e,c=b.total/1024;c>1024?(d=1024/c,e=a("<img>").hide(),e.load(function(){var c,f,a=this.naturalWidth,b=this.naturalHeight;e.appendTo(document.body),e.remove(),e=null,c=0,a==b&&(c=90),f=db(this,d,c,n),eb(f)}),e.attr("src",this.result)):m>c?a.isFunction(imgSizeMin)&&imgSizeMin(c):eb(this.result)},b.onerror=function(a){r.call(this,a)},b.readAsDataURL(this.files[0]),p.call(b,this.files[0])}}),v.click(function(){this.value=""}),hb(),P(),S(),W(),I=a(l),I.length&&I.click(function(){X()}),J=a(window),Y(),J.resize(Y))}a.fn.photoClip=function(b){var c,e;return window.FileReader?(c={width:200,height:200,fileMinSize:20,defaultImg:"",file:"",ok:"",outputType:"jpg",strictSize:!1,loadStart:function(){},loadProgress:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},formatError:function(){},imgSizeMin:function(){}},e=a.extend(c,b),new d(this,e),this):(alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！"),void 0)};var f,e="";return function(){var a,g,b={Webkit:"webkit",Moz:"",O:"o"},c=document.documentElement,d=function(b){return a?a+b:b.toLowerCase()};for(g in b)if(void 0!==c.style[g+"TransitionProperty"]){e="-"+g.toLowerCase()+"-",a=b[g];break}f=d("TransitionEnd")}(),a});